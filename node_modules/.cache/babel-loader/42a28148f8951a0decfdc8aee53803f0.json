{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { RunOnceScheduler } from '../../../base/common/async.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable } from '../../../base/common/lifecycle.js';\nimport { Position } from '../../common/core/position.js';\nimport { Range } from '../../common/core/range.js';\nimport { SnippetParser } from '../snippet/snippetParser.js';\nimport { SnippetSession } from '../snippet/snippetSession.js';\nimport { SuggestController } from '../suggest/suggestController.js';\nimport { minimizeInlineCompletion } from './inlineCompletionsModel.js';\nimport { normalizedInlineCompletionsEquals } from './inlineCompletionToGhostText.js';\nimport { compareBy, compareByNumber, findMaxBy } from './utils.js';\nexport class SuggestWidgetInlineCompletionProvider extends Disposable {\n  constructor(editor, suggestControllerPreselector) {\n    super();\n    this.editor = editor;\n    this.suggestControllerPreselector = suggestControllerPreselector;\n    this.isSuggestWidgetVisible = false;\n    this.isShiftKeyPressed = false;\n    this._isActive = false;\n    this._currentInlineCompletion = undefined;\n    this.onDidChangeEmitter = new Emitter();\n    this.onDidChange = this.onDidChangeEmitter.event; // This delay fixes a suggest widget issue when typing \".\" immediately restarts the suggestion session.\n\n    this.setInactiveDelayed = this._register(new RunOnceScheduler(() => {\n      if (!this.isSuggestWidgetVisible) {\n        if (this._isActive) {\n          this._isActive = false;\n          this.onDidChangeEmitter.fire();\n        }\n      }\n    }, 100)); // See the command acceptAlternativeSelectedSuggestion that is bound to shift+tab\n\n    this._register(editor.onKeyDown(e => {\n      if (e.shiftKey && !this.isShiftKeyPressed) {\n        this.isShiftKeyPressed = true;\n        this.update(this._isActive);\n      }\n    }));\n\n    this._register(editor.onKeyUp(e => {\n      if (e.shiftKey && this.isShiftKeyPressed) {\n        this.isShiftKeyPressed = false;\n        this.update(this._isActive);\n      }\n    }));\n\n    const suggestController = SuggestController.get(this.editor);\n\n    if (suggestController) {\n      this._register(suggestController.registerSelector({\n        priority: 100,\n        select: (model, pos, suggestItems) => {\n          const textModel = this.editor.getModel();\n          const normalizedItemToPreselect = minimizeInlineCompletion(textModel, this.suggestControllerPreselector());\n\n          if (!normalizedItemToPreselect) {\n            return -1;\n          }\n\n          const position = Position.lift(pos);\n          const candidates = suggestItems.map((suggestItem, index) => {\n            const inlineSuggestItem = suggestionToInlineCompletion(suggestController, position, suggestItem, this.isShiftKeyPressed);\n            const normalizedSuggestItem = minimizeInlineCompletion(textModel, inlineSuggestItem);\n\n            if (!normalizedSuggestItem) {\n              return undefined;\n            }\n\n            const valid = rangeStartsWith(normalizedItemToPreselect.range, normalizedSuggestItem.range) && normalizedItemToPreselect.text.startsWith(normalizedSuggestItem.text);\n            return {\n              index,\n              valid,\n              prefixLength: normalizedSuggestItem.text.length,\n              suggestItem\n            };\n          }).filter(item => item && item.valid);\n          const result = findMaxBy(candidates, compareBy(s => s.prefixLength, compareByNumber()));\n          return result ? result.index : -1;\n        }\n      }));\n\n      let isBoundToSuggestWidget = false;\n\n      const bindToSuggestWidget = () => {\n        if (isBoundToSuggestWidget) {\n          return;\n        }\n\n        isBoundToSuggestWidget = true;\n\n        this._register(suggestController.widget.value.onDidShow(() => {\n          this.isSuggestWidgetVisible = true;\n          this.update(true);\n        }));\n\n        this._register(suggestController.widget.value.onDidHide(() => {\n          this.isSuggestWidgetVisible = false;\n          this.setInactiveDelayed.schedule();\n          this.update(this._isActive);\n        }));\n\n        this._register(suggestController.widget.value.onDidFocus(() => {\n          this.isSuggestWidgetVisible = true;\n          this.update(true);\n        }));\n      };\n\n      this._register(Event.once(suggestController.model.onDidTrigger)(e => {\n        bindToSuggestWidget();\n      }));\n    }\n\n    this.update(this._isActive);\n  }\n  /**\n   * Returns undefined if the suggest widget is not active.\n  */\n\n\n  get state() {\n    if (!this._isActive) {\n      return undefined;\n    }\n\n    return {\n      selectedItemAsInlineCompletion: this._currentInlineCompletion\n    };\n  }\n\n  update(newActive) {\n    const newInlineCompletion = this.getInlineCompletion();\n    let shouldFire = false;\n\n    if (!normalizedInlineCompletionsEquals(this._currentInlineCompletion, newInlineCompletion)) {\n      this._currentInlineCompletion = newInlineCompletion;\n      shouldFire = true;\n    }\n\n    if (this._isActive !== newActive) {\n      this._isActive = newActive;\n      shouldFire = true;\n    }\n\n    if (shouldFire) {\n      this.onDidChangeEmitter.fire();\n    }\n  }\n\n  getInlineCompletion() {\n    const suggestController = SuggestController.get(this.editor);\n\n    if (!suggestController) {\n      return undefined;\n    }\n\n    if (!this.isSuggestWidgetVisible) {\n      return undefined;\n    }\n\n    const focusedItem = suggestController.widget.value.getFocusedItem();\n\n    if (!focusedItem) {\n      return undefined;\n    } // TODO: item.isResolved\n\n\n    return suggestionToInlineCompletion(suggestController, this.editor.getPosition(), focusedItem.item, this.isShiftKeyPressed);\n  }\n\n  stopForceRenderingAbove() {\n    const suggestController = SuggestController.get(this.editor);\n\n    if (suggestController) {\n      suggestController.stopForceRenderingAbove();\n    }\n  }\n\n  forceRenderingAbove() {\n    const suggestController = SuggestController.get(this.editor);\n\n    if (suggestController) {\n      suggestController.forceRenderingAbove();\n    }\n  }\n\n}\n\nfunction rangeStartsWith(rangeToTest, prefix) {\n  return rangeToTest.startLineNumber === prefix.startLineNumber && rangeToTest.startColumn === prefix.startColumn && (rangeToTest.endLineNumber < prefix.endLineNumber || rangeToTest.endLineNumber === prefix.endLineNumber && rangeToTest.endColumn <= prefix.endColumn);\n}\n\nfunction suggestionToInlineCompletion(suggestController, position, item, toggleMode) {\n  // additionalTextEdits might not be resolved here, this could be problematic.\n  if (Array.isArray(item.completion.additionalTextEdits) && item.completion.additionalTextEdits.length > 0) {\n    // cannot represent additional text edits\n    return {\n      text: '',\n      range: Range.fromPositions(position, position)\n    };\n  }\n\n  let {\n    insertText\n  } = item.completion;\n\n  if (item.completion.insertTextRules & 4\n  /* InsertAsSnippet */\n  ) {\n    const snippet = new SnippetParser().parse(insertText);\n    const model = suggestController.editor.getModel(); // Ignore snippets that are too large.\n    // Adjust whitespace is expensive for them.\n\n    if (snippet.children.length > 100) {\n      return undefined;\n    }\n\n    SnippetSession.adjustWhitespace(model, position, snippet, true, true);\n    insertText = snippet.toString();\n  }\n\n  const info = suggestController.getOverwriteInfo(item, toggleMode);\n  return {\n    text: insertText,\n    range: Range.fromPositions(position.delta(0, -info.overwriteBefore), position.delta(0, Math.max(info.overwriteAfter, 0)))\n  };\n}","map":{"version":3,"sources":["/home/umut/Documents/cs/cs410/Project2Group14/node_modules/monaco-editor/esm/vs/editor/contrib/inlineCompletions/suggestWidgetInlineCompletionProvider.js"],"names":["RunOnceScheduler","Emitter","Event","Disposable","Position","Range","SnippetParser","SnippetSession","SuggestController","minimizeInlineCompletion","normalizedInlineCompletionsEquals","compareBy","compareByNumber","findMaxBy","SuggestWidgetInlineCompletionProvider","constructor","editor","suggestControllerPreselector","isSuggestWidgetVisible","isShiftKeyPressed","_isActive","_currentInlineCompletion","undefined","onDidChangeEmitter","onDidChange","event","setInactiveDelayed","_register","fire","onKeyDown","e","shiftKey","update","onKeyUp","suggestController","get","registerSelector","priority","select","model","pos","suggestItems","textModel","getModel","normalizedItemToPreselect","position","lift","candidates","map","suggestItem","index","inlineSuggestItem","suggestionToInlineCompletion","normalizedSuggestItem","valid","rangeStartsWith","range","text","startsWith","prefixLength","length","filter","item","result","s","isBoundToSuggestWidget","bindToSuggestWidget","widget","value","onDidShow","onDidHide","schedule","onDidFocus","once","onDidTrigger","state","selectedItemAsInlineCompletion","newActive","newInlineCompletion","getInlineCompletion","shouldFire","focusedItem","getFocusedItem","getPosition","stopForceRenderingAbove","forceRenderingAbove","rangeToTest","prefix","startLineNumber","startColumn","endLineNumber","endColumn","toggleMode","Array","isArray","completion","additionalTextEdits","fromPositions","insertText","insertTextRules","snippet","parse","children","adjustWhitespace","toString","info","getOverwriteInfo","delta","overwriteBefore","Math","max","overwriteAfter"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { RunOnceScheduler } from '../../../base/common/async.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable } from '../../../base/common/lifecycle.js';\nimport { Position } from '../../common/core/position.js';\nimport { Range } from '../../common/core/range.js';\nimport { SnippetParser } from '../snippet/snippetParser.js';\nimport { SnippetSession } from '../snippet/snippetSession.js';\nimport { SuggestController } from '../suggest/suggestController.js';\nimport { minimizeInlineCompletion } from './inlineCompletionsModel.js';\nimport { normalizedInlineCompletionsEquals } from './inlineCompletionToGhostText.js';\nimport { compareBy, compareByNumber, findMaxBy } from './utils.js';\nexport class SuggestWidgetInlineCompletionProvider extends Disposable {\n    constructor(editor, suggestControllerPreselector) {\n        super();\n        this.editor = editor;\n        this.suggestControllerPreselector = suggestControllerPreselector;\n        this.isSuggestWidgetVisible = false;\n        this.isShiftKeyPressed = false;\n        this._isActive = false;\n        this._currentInlineCompletion = undefined;\n        this.onDidChangeEmitter = new Emitter();\n        this.onDidChange = this.onDidChangeEmitter.event;\n        // This delay fixes a suggest widget issue when typing \".\" immediately restarts the suggestion session.\n        this.setInactiveDelayed = this._register(new RunOnceScheduler(() => {\n            if (!this.isSuggestWidgetVisible) {\n                if (this._isActive) {\n                    this._isActive = false;\n                    this.onDidChangeEmitter.fire();\n                }\n            }\n        }, 100));\n        // See the command acceptAlternativeSelectedSuggestion that is bound to shift+tab\n        this._register(editor.onKeyDown(e => {\n            if (e.shiftKey && !this.isShiftKeyPressed) {\n                this.isShiftKeyPressed = true;\n                this.update(this._isActive);\n            }\n        }));\n        this._register(editor.onKeyUp(e => {\n            if (e.shiftKey && this.isShiftKeyPressed) {\n                this.isShiftKeyPressed = false;\n                this.update(this._isActive);\n            }\n        }));\n        const suggestController = SuggestController.get(this.editor);\n        if (suggestController) {\n            this._register(suggestController.registerSelector({\n                priority: 100,\n                select: (model, pos, suggestItems) => {\n                    const textModel = this.editor.getModel();\n                    const normalizedItemToPreselect = minimizeInlineCompletion(textModel, this.suggestControllerPreselector());\n                    if (!normalizedItemToPreselect) {\n                        return -1;\n                    }\n                    const position = Position.lift(pos);\n                    const candidates = suggestItems\n                        .map((suggestItem, index) => {\n                        const inlineSuggestItem = suggestionToInlineCompletion(suggestController, position, suggestItem, this.isShiftKeyPressed);\n                        const normalizedSuggestItem = minimizeInlineCompletion(textModel, inlineSuggestItem);\n                        if (!normalizedSuggestItem) {\n                            return undefined;\n                        }\n                        const valid = rangeStartsWith(normalizedItemToPreselect.range, normalizedSuggestItem.range) &&\n                            normalizedItemToPreselect.text.startsWith(normalizedSuggestItem.text);\n                        return { index, valid, prefixLength: normalizedSuggestItem.text.length, suggestItem };\n                    })\n                        .filter(item => item && item.valid);\n                    const result = findMaxBy(candidates, compareBy(s => s.prefixLength, compareByNumber()));\n                    return result ? result.index : -1;\n                }\n            }));\n            let isBoundToSuggestWidget = false;\n            const bindToSuggestWidget = () => {\n                if (isBoundToSuggestWidget) {\n                    return;\n                }\n                isBoundToSuggestWidget = true;\n                this._register(suggestController.widget.value.onDidShow(() => {\n                    this.isSuggestWidgetVisible = true;\n                    this.update(true);\n                }));\n                this._register(suggestController.widget.value.onDidHide(() => {\n                    this.isSuggestWidgetVisible = false;\n                    this.setInactiveDelayed.schedule();\n                    this.update(this._isActive);\n                }));\n                this._register(suggestController.widget.value.onDidFocus(() => {\n                    this.isSuggestWidgetVisible = true;\n                    this.update(true);\n                }));\n            };\n            this._register(Event.once(suggestController.model.onDidTrigger)(e => {\n                bindToSuggestWidget();\n            }));\n        }\n        this.update(this._isActive);\n    }\n    /**\n     * Returns undefined if the suggest widget is not active.\n    */\n    get state() {\n        if (!this._isActive) {\n            return undefined;\n        }\n        return { selectedItemAsInlineCompletion: this._currentInlineCompletion };\n    }\n    update(newActive) {\n        const newInlineCompletion = this.getInlineCompletion();\n        let shouldFire = false;\n        if (!normalizedInlineCompletionsEquals(this._currentInlineCompletion, newInlineCompletion)) {\n            this._currentInlineCompletion = newInlineCompletion;\n            shouldFire = true;\n        }\n        if (this._isActive !== newActive) {\n            this._isActive = newActive;\n            shouldFire = true;\n        }\n        if (shouldFire) {\n            this.onDidChangeEmitter.fire();\n        }\n    }\n    getInlineCompletion() {\n        const suggestController = SuggestController.get(this.editor);\n        if (!suggestController) {\n            return undefined;\n        }\n        if (!this.isSuggestWidgetVisible) {\n            return undefined;\n        }\n        const focusedItem = suggestController.widget.value.getFocusedItem();\n        if (!focusedItem) {\n            return undefined;\n        }\n        // TODO: item.isResolved\n        return suggestionToInlineCompletion(suggestController, this.editor.getPosition(), focusedItem.item, this.isShiftKeyPressed);\n    }\n    stopForceRenderingAbove() {\n        const suggestController = SuggestController.get(this.editor);\n        if (suggestController) {\n            suggestController.stopForceRenderingAbove();\n        }\n    }\n    forceRenderingAbove() {\n        const suggestController = SuggestController.get(this.editor);\n        if (suggestController) {\n            suggestController.forceRenderingAbove();\n        }\n    }\n}\nfunction rangeStartsWith(rangeToTest, prefix) {\n    return (rangeToTest.startLineNumber === prefix.startLineNumber &&\n        rangeToTest.startColumn === prefix.startColumn &&\n        (rangeToTest.endLineNumber < prefix.endLineNumber ||\n            (rangeToTest.endLineNumber === prefix.endLineNumber &&\n                rangeToTest.endColumn <= prefix.endColumn)));\n}\nfunction suggestionToInlineCompletion(suggestController, position, item, toggleMode) {\n    // additionalTextEdits might not be resolved here, this could be problematic.\n    if (Array.isArray(item.completion.additionalTextEdits) && item.completion.additionalTextEdits.length > 0) {\n        // cannot represent additional text edits\n        return {\n            text: '',\n            range: Range.fromPositions(position, position),\n        };\n    }\n    let { insertText } = item.completion;\n    if (item.completion.insertTextRules & 4 /* InsertAsSnippet */) {\n        const snippet = new SnippetParser().parse(insertText);\n        const model = suggestController.editor.getModel();\n        // Ignore snippets that are too large.\n        // Adjust whitespace is expensive for them.\n        if (snippet.children.length > 100) {\n            return undefined;\n        }\n        SnippetSession.adjustWhitespace(model, position, snippet, true, true);\n        insertText = snippet.toString();\n    }\n    const info = suggestController.getOverwriteInfo(item, toggleMode);\n    return {\n        text: insertText,\n        range: Range.fromPositions(position.delta(0, -info.overwriteBefore), position.delta(0, Math.max(info.overwriteAfter, 0))),\n    };\n}\n"]},"metadata":{},"sourceType":"module"}